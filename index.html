<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Live Class Portal | Total JSON Hub</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Toastify for notifications -->
    <link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/toastify-js/src/toastify.min.css">
    <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/toastify-js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap');

        body {
            font-family: 'Inter', sans-serif;
            background: radial-gradient(circle at top left, #1e293b, #0f172a);
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            overflow-x: hidden;
            padding: 2rem 1rem;
        }

        .blob {
            position: absolute;
            width: 400px;
            height: 400px;
            background: linear-gradient(135deg, #3b82f6 0%, #8b5cf6 100%);
            filter: blur(100px);
            border-radius: 50%;
            z-index: -1;
            opacity: 0.3;
            animation: move 25s infinite alternate;
        }

        @keyframes move {
            from { transform: translate(-20%, -20%); }
            to { transform: translate(30%, 30%); }
        }

        .glass-card {
            background: rgba(255, 255, 255, 0.03);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5);
        }

        .input-glass {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            color: white;
            transition: all 0.3s ease;
        }

        .btn-primary {
            background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
        }

        .resource-item {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.05);
            transition: all 0.2s ease;
        }

        .resource-item:hover {
            background: rgba(255, 255, 255, 0.1);
            transform: translateX(4px);
        }

        .hidden { display: none; }
        
        .custom-scroll::-webkit-scrollbar { width: 4px; }
        .custom-scroll::-webkit-scrollbar-track { background: transparent; }
        .custom-scroll::-webkit-scrollbar-thumb { background: rgba(255, 255, 255, 0.1); border-radius: 10px; }

        /* Spinner for loading */
        .loader {
            border: 2px solid rgba(255, 255, 255, 0.1);
            border-top: 2px solid #3b82f6;
            border-radius: 50%;
            width: 16px;
            height: 16px;
            animation: spin 1s linear infinite;
            display: inline-block;
            vertical-align: middle;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <div class="blob"></div>
    <div class="blob" style="right: 5%; bottom: 5%; background: linear-gradient(135deg, #ec4899 0%, #8b5cf6 100%); animation-delay: -7s;"></div>

    <main class="glass-card w-full max-w-xl rounded-[3rem] p-8 md:p-10 relative overflow-hidden">
        <div class="text-center mb-10">
            <div class="inline-flex items-center justify-center w-14 h-14 rounded-2xl bg-blue-500/10 mb-4 border border-blue-500/20">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-7 w-7 text-blue-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10" />
                </svg>
            </div>
            <h1 class="text-3xl font-bold text-white tracking-tight">Learning Resource Hub</h1>
            <p id="system-status" class="text-slate-500 text-[10px] mt-1 uppercase tracking-[0.2em] font-bold">Syncing Database...</p>
        </div>

        <div class="grid grid-cols-1 gap-8">
            <!-- Section 1: Live Class -->
            <section>
                <h2 class="text-[10px] font-bold text-slate-400 uppercase tracking-[0.2em] mb-4 flex items-center gap-2">
                    <span class="w-2 h-2 rounded-full bg-red-500 animate-pulse"></span>
                    Live Classroom
                </h2>
                <div id="link-status" class="bg-white/5 rounded-3xl p-6 border border-white/5 text-center transition-all duration-500">
                    <div id="no-link-content" class="py-4">
                        <p class="text-slate-500 italic text-sm">Waiting for teacher to post session link...</p>
                    </div>
                    <div id="active-link-content" class="hidden">
                        <div class="flex items-center justify-between mb-4">
                            <span class="px-3 py-1 bg-green-500/10 text-green-400 text-[9px] font-bold uppercase rounded-full border border-green-500/20">Session Ready</span>
                            <p id="last-updated" class="text-[9px] text-slate-500"></p>
                        </div>
                        <a id="join-now-btn" href="#" target="_blank" class="btn-primary block w-full py-4 rounded-2xl text-white font-bold text-center shadow-lg shadow-blue-500/20">
                            Enter Live Meeting
                        </a>
                    </div>
                </div>
            </section>

            <!-- Section 2: Uploaded Documents -->
            <section>
                <h2 class="text-[10px] font-bold text-slate-400 uppercase tracking-[0.2em] mb-4">Class Documents</h2>
                <div id="resource-list" class="space-y-3 max-h-72 overflow-y-auto custom-scroll pr-2">
                    <div class="text-center py-10 border border-dashed border-white/10 rounded-2xl">
                        <p class="text-slate-600 text-sm italic">Loading resources...</p>
                    </div>
                </div>
            </section>
        </div>

        <!-- Footer -->
        <div class="mt-10 pt-6 border-t border-white/5 text-center flex justify-between items-center">
            <span class="text-[10px] text-slate-600 font-bold uppercase tracking-widest">Total JSON Database</span>
            <button onclick="openAdminModal()" class="text-slate-500 hover:text-blue-400 text-[10px] font-bold uppercase tracking-widest transition-all">
                Control Panel
            </button>
        </div>
    </main>

    <!-- Admin Modal -->
    <div id="admin-modal" class="fixed inset-0 z-50 flex items-center justify-center p-4 bg-black/90 backdrop-blur-2xl hidden opacity-0 transition-opacity duration-300">
        <div class="glass-card w-full max-w-md rounded-[2.5rem] p-8 border border-white/20">
            <div class="flex justify-between items-center mb-8">
                <h2 class="text-xl font-bold text-white tracking-tight">Admin Console</h2>
                <button onclick="closeAdminModal()" class="text-slate-400 hover:text-white bg-white/5 p-2 rounded-full">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd" /></svg>
                </button>
            </div>

            <div class="space-y-6">
                <div>
                    <label class="block text-[10px] font-bold text-slate-500 uppercase tracking-widest mb-2">Admin Key</label>
                    <input type="password" id="admin-pass" class="input-glass w-full px-4 py-3 rounded-xl text-sm" placeholder="••••••••">
                </div>

                <div class="pt-4 border-t border-white/5">
                    <div class="flex gap-2 mb-6">
                        <button onclick="switchTab('class')" id="tab-class" class="flex-1 text-[10px] font-bold uppercase tracking-widest py-3 rounded-xl bg-blue-500 text-white transition-all">Zoom Settings</button>
                        <button onclick="switchTab('files')" id="tab-files" class="flex-1 text-[10px] font-bold uppercase tracking-widest py-3 rounded-xl bg-white/5 text-slate-400 transition-all">Files Hub</button>
                    </div>

                    <div id="panel-class" class="space-y-3">
                        <input type="url" id="zoom-link-input" class="input-glass w-full px-4 py-3 rounded-xl text-sm" placeholder="Zoom Link (https://...)">
                        <div class="grid grid-cols-2 gap-2">
                            <button onclick="updateClassLink()" class="btn-primary py-3 rounded-xl text-white text-[10px] font-bold uppercase tracking-widest">Update Link</button>
                            <button onclick="removeClassLink()" class="bg-red-500/10 hover:bg-red-500/20 text-red-400 py-3 rounded-xl text-[10px] font-bold uppercase border border-red-500/20">Clear</button>
                        </div>
                    </div>

                    <div id="panel-files" class="space-y-4 hidden">
                        <div class="p-6 bg-white/5 border border-white/10 rounded-2xl text-center">
                            <p class="text-[10px] font-bold text-blue-400 uppercase tracking-widest mb-4">Direct File Storage</p>
                            <input type="file" id="local-file-input" class="hidden" onchange="processFile(this)">
                            <button id="upload-btn" onclick="document.getElementById('local-file-input').click()" class="w-full bg-blue-600 hover:bg-blue-500 text-white py-4 rounded-xl text-[10px] font-bold uppercase tracking-widest transition-all shadow-lg shadow-blue-500/10">
                                <span id="btn-text">Select & Store File</span>
                                <div id="btn-loader" class="loader hidden ml-2"></div>
                            </button>
                            <p class="text-[9px] text-slate-500 mt-3 font-medium italic">Files are converted to text and stored in JSONbin</p>
                        </div>
                        <button onclick="clearResources()" class="w-full bg-red-500/10 hover:bg-red-500/20 text-red-400 py-3 rounded-xl text-[10px] font-bold uppercase border border-red-500/10 transition-all">Delete All Stored Files</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // --- CONFIGURATION ---
        const BIN_ID = "695166c5d0ea881f404590bc"; 
        const MASTER_KEY = "$2a$10$5DUBLN1C3earHx9hDBECqe02BXZh050D8WD/Cu2yY/DcfvV.zxPCm"; 
        const ADMIN_CRED = "admin786";
        const API_URL = `https://api.jsonbin.io/v3/b/${BIN_ID}`;

        let currentData = { link: "", timestamp: "", resources: [] };

        // --- CORE DATABASE LOGIC ---
        async function fetchData() {
            try {
                const response = await fetch(`${API_URL}/latest`, { 
                    headers: { "X-Master-Key": MASTER_KEY, "X-Bin-Meta": false } 
                });
                if (!response.ok) throw new Error();
                currentData = await response.json();
                renderUI();
                document.getElementById('system-status').innerText = "Live • Storage Synced";
            } catch (error) {
                document.getElementById('system-status').innerText = "Database Connection Error";
            }
        }

        async function saveToDB() {
            try {
                const response = await fetch(API_URL, {
                    method: 'PUT',
                    headers: { 
                        "Content-Type": "application/json", 
                        "X-Master-Key": MASTER_KEY 
                    },
                    body: JSON.stringify(currentData)
                });
                if(!response.ok) throw new Error();
                await fetchData();
                showToast("Database Updated Successfully", "#10b981");
            } catch (err) {
                showToast("Update Failed: File might be too large", "#f43f5e");
            }
        }

        function renderUI() {
            // Render Live Class
            const noLink = document.getElementById('no-link-content');
            const active = document.getElementById('active-link-content');
            if (currentData.link && currentData.link !== "") {
                noLink.classList.add('hidden');
                active.classList.remove('hidden');
                document.getElementById('join-now-btn').href = currentData.link;
                document.getElementById('last-updated').innerText = `Update: ${currentData.timestamp}`;
            } else {
                noLink.classList.remove('hidden');
                active.classList.add('hidden');
            }

            // Render File Hub
            const list = document.getElementById('resource-list');
            if (!currentData.resources || currentData.resources.length === 0) {
                list.innerHTML = `<div class="text-center py-10 border border-dashed border-white/10 rounded-2xl"><p class="text-slate-600 text-sm italic">No files currently stored.</p></div>`;
            } else {
                list.innerHTML = currentData.resources.map((res, index) => `
                    <div class="resource-item p-4 rounded-2xl flex items-center justify-between group">
                        <div class="flex items-center gap-4 overflow-hidden">
                            <div class="shrink-0 w-10 h-10 rounded-xl bg-blue-500/10 flex items-center justify-center text-blue-400">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 21h10a2 2 0 002-2V9.414a1 1 0 00-.293-.707l-5.414-5.414A1 1 0 0012.586 3H7a2 2 0 00-2 2v14a2 2 0 002 2z" /></svg>
                            </div>
                            <div class="overflow-hidden">
                                <h4 class="text-white text-sm font-semibold truncate max-w-[150px] md:max-w-[250px]">${res.name}</h4>
                                <p class="text-[9px] text-slate-500 uppercase tracking-widest font-bold">Stored Document</p>
                            </div>
                        </div>
                        <button onclick="downloadFile('${index}')" class="bg-blue-600 hover:bg-blue-500 text-white px-4 py-2 rounded-lg text-[9px] font-bold uppercase transition-all shadow-md">Download</button>
                    </div>
                `).join('');
            }
        }

        // --- FILE PROCESSING (BASE64) ---
        window.processFile = (input) => {
            const pass = document.getElementById('admin-pass').value;
            if (pass !== ADMIN_CRED) {
                showToast("Access Denied", "#f43f5e");
                input.value = "";
                return;
            }

            const file = input.files[0];
            if (!file) return;

            // Show loading state
            const btnText = document.getElementById('btn-text');
            const loader = document.getElementById('btn-loader');
            btnText.innerText = "Storing...";
            loader.classList.remove('hidden');

            const reader = new FileReader();
            reader.onload = async (e) => {
                const base64Data = e.target.result; // Full Data URL (Base64)
                
                if (!currentData.resources) currentData.resources = [];
                currentData.resources.push({
                    name: file.name,
                    data: base64Data // Stored as part of the JSON!
                });

                await saveToDB();
                
                btnText.innerText = "Select & Store File";
                loader.classList.add('hidden');
                input.value = "";
            };
            
            reader.onerror = () => {
                showToast("Read Error", "#f43f5e");
                btnText.innerText = "Select & Store File";
                loader.classList.add('hidden');
            };

            reader.readAsDataURL(file); // Convert file to text
        };

        window.downloadFile = (index) => {
            const file = currentData.resources[index];
            if (!file) return;

            const link = document.createElement("a");
            link.href = file.data;
            link.download = file.name;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            showToast("Downloading File...", "#3b82f6");
        };

        // --- ADMIN HELPERS ---
        window.updateClassLink = () => {
            if (document.getElementById('admin-pass').value !== ADMIN_CRED) return showToast("Wrong Key", "#f43f5e");
            const link = document.getElementById('zoom-link-input').value;
            if (!link.startsWith('http')) return showToast("Invalid URL", "#f59e0b");
            currentData.link = link;
            currentData.timestamp = new Date().toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
            saveToDB();
            closeAdminModal();
        };

        window.removeClassLink = () => {
            if (document.getElementById('admin-pass').value !== ADMIN_CRED) return showToast("Wrong Key", "#f43f5e");
            currentData.link = "";
            saveToDB();
            closeAdminModal();
        };

        window.clearResources = () => {
            if (document.getElementById('admin-pass').value !== ADMIN_CRED) return showToast("Wrong Key", "#f43f5e");
            currentData.resources = [];
            saveToDB();
        };

        // --- UI UTILITIES ---
        window.switchTab = (t) => {
            const pC = document.getElementById('panel-class'); const pF = document.getElementById('panel-files');
            const tC = document.getElementById('tab-class'); const tF = document.getElementById('tab-files');
            if (t === 'class') {
                pC.classList.remove('hidden'); pF.classList.add('hidden');
                tC.className = "flex-1 text-[10px] font-bold uppercase tracking-widest py-3 rounded-xl bg-blue-500 text-white transition-all";
                tF.className = "flex-1 text-[10px] font-bold uppercase tracking-widest py-3 rounded-xl bg-white/5 text-slate-400 transition-all";
            } else {
                pF.classList.remove('hidden'); pC.classList.add('hidden');
                tF.className = "flex-1 text-[10px] font-bold uppercase tracking-widest py-3 rounded-xl bg-blue-500 text-white transition-all";
                tC.className = "flex-1 text-[10px] font-bold uppercase tracking-widest py-3 rounded-xl bg-white/5 text-slate-400 transition-all";
            }
        };

        function showToast(m, c) {
            Toastify({ text: m, duration: 3000, style: { background: c, borderRadius: "12px", fontSize: "11px", fontWeight: "bold" } }).showToast();
        }

        window.openAdminModal = () => {
            const m = document.getElementById('admin-modal');
            m.classList.remove('hidden'); setTimeout(() => m.classList.add('opacity-100'), 10);
        };

        window.closeAdminModal = () => {
            const m = document.getElementById('admin-modal');
            m.classList.remove('opacity-100'); setTimeout(() => m.classList.add('hidden'), 300);
        };

        // Init Polling
        setInterval(fetchData, 10000);
        fetchData();
    </script>
</body>
</html>